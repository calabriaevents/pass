<?php
require_once __DIR__ . '/auth_check.php';
require_once '../includes/config.php';
require_once '../includes/database_mysql.php';
require_once '../includes/image_processor.php';

// --- Robustness Checks ---

// 1. Check for GD extension
if (!extension_loaded('gd')) {
    if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['image'])) {
        header('Content-Type: application/json');
        echo json_encode(['success' => false, 'error' => 'L\'estensione PHP GD non è installata o abilitata. Impossibile elaborare le immagini.']);
        exit;
    }
    die('Errore Critico: L\'estensione PHP GD è richiesta per la gestione delle immagini.');
}

// 2. Check for upload size limits exceeded (silent failure case)
if ($_SERVER['REQUEST_METHOD'] === 'POST' && empty($_FILES) && empty($_POST) && isset($_SERVER['CONTENT_LENGTH']) && $_SERVER['CONTENT_LENGTH'] > 0) {
    header('Content-Type: application/json');
    $postMaxSize = ini_get('post_max_size');
    echo json_encode(['success' => false, 'error' => "Il file è troppo grande. Supera il limite del server (post_max_size) di {$postMaxSize}."]);
    exit;
}

// --- End Robustness Checks ---

$db = new Database();
$imageProcessor = new ImageProcessor();

// Handle asynchronous image uploads
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['image'])) {
    header('Content-Type: application/json');
    try {
        $subfolder = 'homepage/generale'; // Default folder
        if (isset($_POST['target'])) {
            $target = $_POST['target'];
            if (strpos($target, 'hero_image') !== false) {
                $subfolder = 'homepage/hero';
            } elseif (strpos($target, 'app_store_image') !== false || strpos($target, 'play_store_image') !== false) {
                $subfolder = 'homepage/badges';
            } elseif (strpos($target, 'bg_image') !== false) {
                $subfolder = 'homepage/backgrounds';
            }
        }

        $relativePath = $imageProcessor->processUploadedImage($_FILES['image'], $subfolder);

        if ($relativePath === null) {
            throw new Exception($imageProcessor->getLastError() ?: 'Errore sconosciuto durante l\'elaborazione dell\'immagine.');
        }

        $safePath = '../image-loader.php?path=' . urlencode($relativePath);
        echo json_encode(['success' => true, 'path' => $relativePath, 'safe_path' => $safePath]);

    } catch (Exception $e) {
        http_response_code(400); // Bad Request
        echo json_encode(['success' => false, 'error' => $e->getMessage()]);
    }
    exit;
}

// Handle section updates
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action'])) {
    // ... (rest of the file remains the same)
    // Code omitted for brevity as it's not being changed
    // ...
}

// Load current data
$homeSections = $db->getHomeSections();
// ... (rest of the file remains the same)
?>
<!-- HTML part of the file remains unchanged -->
